<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <title>Job Posting Management - BaoNgoCV</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/whole.css" rel="stylesheet">

    <script src="/js/FetchNotification.js" defer></script>
    <script src="/js/Toast.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/Notification-filtering.js" defer></script>

    <style>
        :root {
            --primary-color: #ff6b35;
            --primary-hover: #e85a25;
            --primary-soft: rgba(255, 107, 53, 0.1);
            --bg-body: #f8f9fc;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --info-bg: #e0f2fe;
            --info-text: #075985;
            --radius-lg: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-header-custom {
            position: static !important;
            top: auto !important;
            z-index: auto !important;
            padding: 1rem 0 1.5rem; /* Top nhỏ hơn, bottom giữ nguyên */
            background: var(--bg-body);
        }



        /* Hoặc nếu dùng thẻ <header> trực tiếp */
        header.page-header-custom {
            position: static !important;
        }

        /* Đảm bảo container bên trong cũng không sticky */
        .page-header-custom .container,
        .page-header-custom .page-header-section {
            position: static !important;
        }

        /* Tăng z-index cho navigation header để luôn ở trên */
        header.sticky-top,
        nav.sticky-top {
            z-index: 1030 !important; /* Bootstrap navbar z-index là 1030 */
        }

        /* Đẩy nội dung xuống để không bị che bởi sticky header */
        main.container {
            padding-top: 1rem; /* Điều chỉnh nếu cần */
        }



        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, h4, h5, .page-title, .card-title-link, .modal-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        main { padding: 3rem 0; }
        .page-header-section { margin-bottom: 2.5rem; animation: fadeInDown 0.6s ease-out; }
        .page-title { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; letter-spacing: -0.025em; }
        .page-header-desc { color: var(--text-muted); font-size: 1rem; max-width: 600px; }
        .btn-create-job { background-color: var(--primary-color); color: white; padding: 0.875rem 1.75rem; border-radius: 50px; font-weight: 600; border: none; box-shadow: var(--shadow-md); transition: var(--transition); display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-create-job:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255, 107, 53, 0.25); color: white; }

        .statistics-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; animation: fadeInUp 0.6s ease-out 0.1s both; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; border: 1px solid rgba(255,255,255,0.5); display: flex; align-items: center; justify-content: space-between; transition: var(--transition); position: relative; overflow: hidden; box-shadow: var(--shadow-sm); }
        .stat-card::after { content: ''; position: absolute; right: -20px; bottom: -20px; width: 100px; height: 100px; border-radius: 50%; opacity: 0.1; z-index: 0; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .stat-content { z-index: 1; display: flex; flex-direction: column; }
        .stat-value { font-size: 2.25rem; font-weight: 700; color: var(--text-main); line-height: 1; margin-top: 0.5rem; letter-spacing: -0.03em; }
        .stat-label { font-size: 0.875rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-icon-wrapper { width: 56px; height: 56px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; z-index: 1; transition: transform 0.3s ease; }
        .stat-card:hover .stat-icon-wrapper { transform: scale(1.1) rotate(5deg); }
        .stat-card .stat-icon-wrapper { background: #fff1eb; color: var(--primary-color); }
        .stat-card::after { background: var(--primary-color); }
        .stat-card.success .stat-icon-wrapper { background: var(--success-bg); color: var(--success-text); }
        .stat-card.success::after { background: var(--success-text); }
        .stat-card.danger .stat-icon-wrapper { background: var(--danger-bg); color: var(--danger-text); }
        .stat-card.danger::after { background: var(--danger-text); }
        .stat-card.info .stat-icon-wrapper { background: var(--info-bg); color: var(--info-text); }
        .stat-card.info::after { background: var(--info-text); }
        .stat-card.warning .stat-icon-wrapper { background: var(--warning-bg); color: var(--warning-text); }
        .stat-card.warning::after { background: var(--warning-text); }

        .subscription-card { background: linear-gradient(145deg, #ffffff 0%, #fff7ed 100%); border-radius: var(--radius-lg); padding: 2rem; margin-bottom: 3rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); position: relative; overflow: hidden; animation: fadeInUp 0.6s ease-out 0.2s both; }
        .subscription-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary-color); }
        .plan-badge { background: var(--text-main); color: white; padding: 0.5rem 1rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .job-card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; animation: fadeInUp 0.6s ease-out 0.3s both; }
        .job-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); transition: var(--transition); overflow: hidden; height: 100%; display: flex; flex-direction: column; position: relative; }
        .job-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); border-color: rgba(255, 107, 53, 0.3); }
        .job-card .card-header { background: transparent; padding: 1.5rem 1.5rem 0.5rem; border: none; }
        .card-title-link { font-size: 1.25rem; font-weight: 700; color: var(--text-main); text-decoration: none; display: block; margin-bottom: 0.25rem; transition: color 0.2s; line-height: 1.3; }
        .card-title-link:hover { color: var(--primary-color); }
        .company-name { font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.5rem; }
        .card-status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-badge-modern { font-size: 0.75rem; font-weight: 600; padding: 0.35em 0.8em; border-radius: 6px; display: inline-flex; align-items: center; }
        .status-open { background: var(--success-bg); color: var(--success-text); }
        .status-closed { background: var(--danger-bg); color: var(--danger-text); }
        .status-draft { background: #f1f5f9; color: #475569; }
        .job-quick-info { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; margin-bottom: 1.5rem; }
        .info-tag { font-size: 0.8rem; padding: 0.4rem 0.75rem; background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-muted); display: flex; align-items: center; gap: 0.4rem; font-weight: 500; }
        .info-tag i { color: #94a3b8; }
        .applicant-section { background: #f8fafc; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin-top: auto; }
        .applicant-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main); }
        .card-actions { padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; background: #ffffff; }
        .btn-view-applicants { flex-grow: 1; background: var(--primary-soft); color: var(--primary-color); font-weight: 600; padding: 0.6rem 1rem; border-radius: 10px; text-decoration: none; text-align: center; font-size: 0.9rem; transition: var(--transition); }
        .btn-view-applicants:hover { background: var(--primary-color); color: white; box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2); }
        .action-icon-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--border-color); color: var(--text-muted); background: white; transition: var(--transition); cursor: pointer; }
        .action-icon-btn:hover { background: #f1f5f9; color: var(--text-main); border-color: #cbd5e1; }
        .action-icon-btn.danger:hover { background: var(--danger-bg); color: var(--danger-text); border-color: var(--danger-bg); }

        .modal-content { border: none; border-radius: 24px; box-shadow: var(--shadow-hover); }
        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid #f1f5f9; }
        .modal-body { padding: 2rem; }
        .modal-footer { padding: 1.5rem 2rem; background: #f8fafc; border-top: 1px solid #f1f5f9; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        .form-control, .form-select { padding: 0.75rem 1rem; border-radius: 10px; border: 1px solid var(--border-color); background-color: #fdfdfd; }
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 4px var(--primary-soft); border-color: var(--primary-color); background-color: #fff; }

        .bg-danger-soft { background-color: rgba(254, 226, 226, 0.5); }
        .border-opacity-25 { border-color: rgba(220, 53, 69, 0.25) !important; }
        .bg-opacity-10 { --bs-bg-opacity: 0.1; }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .job-card-wrapper-hiding { opacity: 0; transform: scale(0.9); height: 0; margin: 0; padding: 0; overflow: hidden; transition: all 0.4s ease; }
        .badge-expiring { background-color: var(--warning-bg); color: var(--warning-text); font-size: 0.7rem; padding: 0.2rem 0.6rem; border-radius: 4px; margin-left: 0.5rem; }
        .dynamic-list-container { max-height: 200px; overflow-y: auto; border-radius: 10px; }
        .dynamic-list-container::-webkit-scrollbar { width: 6px; }
        .dynamic-list-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Client-side rendering loading state */
        .content-loading {
            opacity: 0.5;
            pointer-events: none;
            position: relative;
            transition: opacity 0.3s ease;
        }

        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px; /* Ensure it has some height */
        }

        /* Pagination style from transaction-history.html */
        .pagination-wrapper {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: linear-gradient(to top, #FAFBFC 0%, white 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
        }
        .pagination {
            gap: 0.375rem;
        }
        .pagination .page-link {
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem 0.875rem;
            min-width: 36px;
            text-align: center;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            background-color: white;
        }
        .pagination .page-item.active .page-link {
            background: linear-gradient(135deg, #ff6b35 0%, #e03e00 100%);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        .pagination .page-link:hover:not(.active) {
            background-color: var(--primary-soft);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/headerAndFooter :: header}"></div>
<!-- NEW CUSTOM HEADER -->
<header class="page-header-custom">
    <div class="container">
        <div class="page-header-section mb-0">
            <div class="d-flex justify-content-between align-items-end flex-wrap gap-3">
                <div>
                    <h1 class="page-title">Job Listings</h1>
                    <p class="page-header-desc mb-0">Manage your active vacancies, track applicant progress, and update job details.</p>
                </div>
                <a href="/company/post-a-job" class="btn-create-job">
                    <i class="fas fa-plus"></i> Post New Job
                </a>
            </div>
        </div>
    </div>
</header>

<main class="container">

    <div class="statistics-dashboard" th:if="${response.statistics() != null}">
        <div class="stat-card">
            <div class="stat-content">
                <span class="stat-label">Total Jobs</span>
                <span class="stat-value" th:text="${response.statistics().totalJobs()}">0</span>
            </div>
            <div class="stat-icon-wrapper"><i class="fas fa-briefcase"></i></div>
        </div>
        <div class="stat-card success">
            <div class="stat-content">
                <span class="stat-label">Active</span>
                <span class="stat-value" th:text="${response.statistics().openJobs()}">0</span>
            </div>
            <div class="stat-icon-wrapper"><i class="fas fa-check-circle"></i></div>
        </div>
        <div class="stat-card danger">
            <div class="stat-content">
                <span class="stat-label">Closed</span>
                <span class="stat-value" th:text="${response.statistics().closedJobs()}">0</span>
            </div>
            <div class="stat-icon-wrapper"><i class="fas fa-archive"></i></div>
        </div>
        <div class="stat-card info">
            <div class="stat-content">
                <span class="stat-label">Candidates</span>
                <span class="stat-value" th:text="${response.statistics().totalApplications()}">0</span>
            </div>
            <div class="stat-icon-wrapper"><i class="fas fa-users"></i></div>
        </div>
    </div>

    <div class="subscription-card" th:if="${response.subscriptionUsage() != null}">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <h5 class="mb-0 fw-bold">Current Plan Usage</h5>
                    <span class="plan-badge" th:text="${response.subscriptionUsage().planName()}">Basic Plan</span>
                </div>
                <div class="d-flex align-items-center text-muted small mb-3">
                    <span class="me-2">Jobs Posted:</span>
                    <strong class="text-dark"><span th:text="${response.subscriptionUsage().used()}">0</span> / <span th:text="${response.subscriptionUsage().limit()}">10</span></strong>
                </div>
                <div class="progress" style="height: 8px; background-color: rgba(0,0,0,0.05);">
                    <div class="progress-bar" role="progressbar"
                         th:style="'width: ' + ${response.subscriptionUsage().percentage()} + '%; background-color: var(--primary-color);'"
                         th:classappend="${response.subscriptionUsage().percentage() >= 100 ? 'bg-danger' : ''}">
                    </div>
                </div>
                <div class="mt-2 small text-danger fw-semibold" th:if="${response.subscriptionUsage().hasReachedLimit()}">
                    <i class="fas fa-exclamation-circle me-1"></i> Limit reached. Upgrade to post more.
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0" th:if="${response.subscriptionUsage().planName() != 'Premium plan'}">
                <a href="/company/profile" class="btn btn-outline-dark rounded-pill px-4 fw-semibold btn-sm">Upgrade Plan</a>
            </div>
        </div>
    </div>

    <div class="job-card-grid" id="job-card-grid" th:if="${response.jobPostings() != null and !response.jobPostings().isEmpty()}">
        <div th:each="job : ${response.jobPostings()}" th:id="'job-card-wrapper-' + ${job.id}">
            <div class="job-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="status-badge-modern"
                              th:classappend="${job.status != null && job.status == 'OPEN' ? 'status-open' : (job.status != null && job.status == 'CLOSED' ? 'status-closed' : 'status-draft')}">
                            <span class="card-status-dot" th:style="${job.status == 'OPEN' ? 'background: currentColor' : 'background: currentColor'}"></span>
                            <span th:text="${job.status}">OPEN</span>
                        </span>
                        <span class="badge-expiring"
                              th:if="${job.applicationDeadline != null && job.applicationDeadline.isBefore(T(java.time.LocalDate).now().plusDays(7)) && job.applicationDeadline.isAfter(T(java.time.LocalDate).now())}">
                            <i class="fas fa-clock me-1"></i>Expiring
                        </span>
                    </div>
                    <a th:href="@{/jobseeker/job-detail/{id}(id=${job.id})}" class="card-title-link" th:text="${job.title}">Senior Java Developer</a>
                    <div class="company-name" th:if="${job.companyName != null}">
                        <span th:text="${job.companyName}">Company Name</span>
                    </div>
                </div>

                <div class="card-body pt-0 pb-0 d-flex flex-column">
                    <div class="job-quick-info">
                        <div class="info-tag" data-field="jobType" th:if="${job.jobType != null}">
                            <i class="far fa-clock"></i> <span th:text="${job.jobType}">Full-time</span>
                        </div>
                        <div class="info-tag" data-field="location" th:if="${job.location != null}">
                            <i class="fas fa-map-marker-alt"></i> <span th:text="${job.location}">Hanoi</span>
                        </div>
                        <div class="info-tag" data-field="salaryRange" th:if="${job.salaryRange != null}">
                            <i class="fas fa-dollar-sign"></i> <span th:text="${job.salaryRange}">$1000</span>
                        </div>
                        <div class="info-tag" data-field="experience" th:if="${job.experience != null}">
                            <i class="fas fa-briefcase"></i> <span th:text="${job.experience}">2 Yrs</span>
                        </div>
                    </div>
                </div>

                <div class="applicant-section">
                    <div class="applicant-header">
                        <span><i class="fas fa-user-friends me-1 text-primary"></i> Applicants</span>
                        <span>
                            <span th:text="${job.applicantCount != null ? job.applicantCount : 0}" class="fw-bold text-dark">0</span>
                            <span class="text-muted fw-normal" th:if="${job.maxApplicants != null}"> / <span th:text="${job.maxApplicants}">50</span></span>
                        </span>
                    </div>
                    <div class="progress" style="height: 6px; background-color: #e2e8f0; border-radius: 99px;">
                        <div class="progress-bar"
                             th:style="'width: ' + ${(job.maxApplicants != null && job.maxApplicants > 0) ? (job.applicantCount * 100.0 / job.maxApplicants) : 0} + '%; background-color: var(--success-text); border-radius: 99px;'">
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <a th:href="@{/company/job-view-applicants(jobId=${job.id})}" class="btn-view-applicants">
                        Review Applicants
                    </a>
                    <div class="d-flex gap-2">
                        <a th:href="@{/jobseeker/job-detail/{id}(id=${job.id})}" target="_blank" class="action-icon-btn" data-bs-toggle="tooltip" title="View Public Page">
                            <i class="far fa-eye"></i>
                        </a>
                        <button class="action-icon-btn" th:id="'edit-btn-card-' + ${job.id}" data-bs-toggle="modal" th:data-bs-target="'#editModal_' + ${job.id}" title="Edit Job">
                            <i class="far fa-edit"></i>
                        </button>
                        <button class="action-icon-btn danger" type="button"
                                th:attr="onclick=|prepareDeleteModal(${job.id},
                                            '${#strings.escapeJavaScript(job.title)}',
                                            ${job.applicantCount != null ? job.applicantCount : 0},
                                            '${job.status}',
                                            '${job.applicationDeadline != null ? #temporals.format(job.applicationDeadline, 'dd/MM/yyyy') : 'No Date'}')|"
                                title="Delete Job">
                            <i class="far fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="empty-state text-center py-5" th:if="${response.jobPostings() == null or response.jobPostings().isEmpty()}">
        <div class="mb-4">
            <div style="width: 100px; height: 100px; background: #fff7ed; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: var(--primary-color);">
                <i class="fas fa-briefcase fa-3x"></i>
            </div>
        </div>
        <h3 class="mb-2 fw-bold text-dark">No job postings yet</h3>
        <p class="text-muted mb-4">Create your first job opportunity to start attracting top talent to your company.</p>
        <a href="/company/post-a-job" class="btn-create-job">Create First Job</a>
    </div>

    <div class="pagination-wrapper" id="pagination-container" th:if="${response.pagination() != null and response.pagination().totalPages() > 1}">
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${response.pagination().currentPage() == 0} ? 'disabled'">
                    <a class="page-link" th:href="@{/company/jobposting-managing(page=${response.pagination().currentPage() - 1})}">
                        <i class="fas fa-chevron-left small"></i>
                    </a>
                </li>
                <li class="page-item"
                    th:each="i : ${#numbers.sequence(0, response.pagination().totalPages() - 1)}"
                    th:classappend="${i == response.pagination().currentPage()} ? 'active'">
                    <a class="page-link" th:href="@{/company/jobposting-managing(page=${i})}" th:text="${i + 1}">1</a>
                </li>
                <li class="page-item" th:classappend="${response.pagination().currentPage() >= response.pagination().totalPages() - 1} ? 'disabled'">
                    <a class="page-link" th:href="@{/company/jobposting-managing(page=${response.pagination().currentPage() + 1})}">
                        <i class="fas fa-chevron-right small"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- ========== EDIT MODAL - FULL VERSION ========== -->
    <div id="modals-container" th:if="${response.jobPostings() != null}" th:each="job : ${response.jobPostings()}">
        <div th:id="'editModal_' + ${job.id}" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-bold">Edit Job Posting</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form th:id="'editForm_' + ${job.id}" onsubmit="return false;">
                        <input type="hidden" name="id" th:value="${job.id}" />
                        <div class="modal-body">
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Job Title</label>
                                <input type="text" class="form-control form-control-lg" name="title" th:value="${job.title}" placeholder="e.g. Senior Software Engineer" />
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Job Type</label>
                                    <select class="form-select" name="jobType">
                                        <option th:each="type : ${T(com.example.baoNgoCv.model.enums.JobType).values()}"
                                                th:value="${type.name()}"
                                                th:text="${type.displayName}"
                                                th:selected="${type.name() == job.jobType}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Location</label>
                                    <select class="form-select" name="location">
                                        <option th:each="loc : ${T(com.example.baoNgoCv.model.enums.LocationType).values()}"
                                                th:value="${loc.name()}"
                                                th:text="${loc.displayName}"
                                                th:selected="${loc.name() == job.location}"></option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Salary Range</label>
                                    <select class="form-select" name="salaryRange">
                                        <option th:each="salary : ${T(com.example.baoNgoCv.model.enums.SalaryRange).values()}"
                                                th:value="${salary.name()}"
                                                th:text="${salary.displayName}"
                                                th:selected="${salary.name() == job.salaryRange}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Experience</label>
                                    <select class="form-select" name="experience">
                                        <option th:each="exp : ${T(com.example.baoNgoCv.model.enums.ExperienceLevel).values()}"
                                                th:value="${exp.name()}"
                                                th:text="${exp.displayName}"
                                                th:selected="${exp.name() == job.experience}"></option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-muted small fw-bold text-uppercase">Industry</label>
                                <select class="form-select" name="industry">
                                    <option th:each="ind : ${T(com.example.baoNgoCv.model.enums.IndustryType).values()}"
                                            th:value="${ind.name()}"
                                            th:text="${ind.displayName}"
                                            th:selected="${ind.name() == job.industry}"></option>
                                </select>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Deadline</label>
                                    <input type="date" class="form-control" name="applicationDeadline"
                                           th:value="${job.applicationDeadline != null ? #temporals.format(job.applicationDeadline, 'yyyy-MM-dd') : ''}" />
                                    <div class="form-text small text-muted mt-2"><i class="fas fa-info-circle me-1"></i>Note: The deadline can only be extended, not shortened.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small fw-bold text-uppercase">Max Applicants</label>
                                    <input type="number" class="form-control" name="maxApplicants" th:value="${job.maxApplicants}" />
                                </div>
                            </div>

                            <!-- Dynamic Lists -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0">Descriptions</label>
                                    <button type="button" class="btn btn-sm btn-light text-primary fw-bold" th:onclick="|addField('descriptions-container-${job.id}', 'descriptions')|"><i class="fas fa-plus small"></i></button>
                                </div>
                                <div class="dynamic-list-container bg-light p-3" th:id="'descriptions-container-' + ${job.id}">
                                    <div th:each="desc : ${job.descriptions}" class="input-group mb-2">
                                        <input type="text" class="form-control border-end-0" name="descriptions" th:value="${desc}" />
                                        <button type="button" class="btn btn-outline-danger border-start-0 bg-white" onclick="this.closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0">Requirements</label>
                                    <button type="button" class="btn btn-sm btn-light text-primary fw-bold" th:onclick="|addField('requirements-container-${job.id}', 'requirements')|"><i class="fas fa-plus small"></i></button>
                                </div>
                                <div class="dynamic-list-container bg-light p-3" th:id="'requirements-container-' + ${job.id}">
                                    <div th:each="req : ${job.requirements}" class="input-group mb-2">
                                        <input type="text" class="form-control border-end-0" name="requirements" th:value="${req}" />
                                        <button type="button" class="btn btn-outline-danger border-start-0 bg-white" onclick="this.closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold mb-0">Benefits</label>
                                    <button type="button" class="btn btn-sm btn-light text-primary fw-bold" th:onclick="|addField('benefits-container-${job.id}', 'benefits')|"><i class="fas fa-plus small"></i></button>
                                </div>
                                <div class="dynamic-list-container bg-light p-3" th:id="'benefits-container-' + ${job.id}">
                                    <div th:each="ben : ${job.benefits}" class="input-group mb-2">
                                        <input type="text" class="form-control border-end-0" name="benefits" th:value="${ben}" />
                                        <button type="button" class="btn btn-outline-danger border-start-0 bg-white" onclick="this.closest('.input-group').remove()"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <div class="me-auto text-muted small">
                                <span th:id="'edit-count-wrapper-' + ${job.id}" th:classappend="${job.editCount != null and job.editCount >= 1} ? 'text-danger fw-semibold'">
                                    Edits: <span th:id="'edit-count-text-' + ${job.id}" th:text="${job.editCount != null ? job.editCount : 0}">0</span>/1
                                </span>
                                <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="You can edit a job posting up to 1 time."></i>
                            </div>
                            <button type="button" class="btn btn-light text-muted fw-semibold" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary px-4 fw-semibold rounded-pill"
                                    th:onclick="'showEditConfirmation(' + ${job.id} + ')'"
                                    th:disabled="${job.editCount != null and job.editCount >= 1}"
                                    th:text="${(job.editCount != null and job.editCount >= 1) ? 'Limit Reached' : 'Save Changes'}"></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</main>

<!-- ========== DELETE CONFIRMATION MODAL ========== -->
<div class="modal fade" id="deleteJobModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg overflow-hidden" style="border-radius: 24px;">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 pt-2">
                <div class="row g-0">
                    <div class="col-md-5 pe-md-4 border-end border-light d-flex flex-column justify-content-center">
                        <div class="text-center mb-4">
                            <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 72px; height: 72px; background-color: var(--primary-soft); color: var(--primary-color);">
                                <i class="fas fa-trash-alt fa-2x"></i>
                            </div>
                            <h4 class="fw-bold text-dark mb-1">Delete Job Posting?</h4>
                            <p class="text-muted small mb-0">This action is permanent</p>
                        </div>

                        <div class="p-3 bg-light rounded-3 border border-light">
                            <div class="small text-uppercase text-muted fw-bold mb-2" style="font-size: 0.7rem; letter-spacing: 0.5px;">Target Job</div>
                            <div class="fw-bold text-dark mb-3" id="delete-job-title-display" style="font-size: 1.15rem; line-height: 1.3;">Senior Java Developer</div>
                            <div class="d-flex flex-column gap-2 small">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted"><i class="far fa-flag me-1"></i>Status:</span>
                                    <span id="delete-job-status" class="badge bg-success">OPEN</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted"><i class="far fa-calendar me-1"></i>Deadline:</span>
                                    <span id="delete-job-posted-date" class="fw-semibold text-dark">--/--/----</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7 ps-md-4 d-flex flex-column">
                        <h6 class="fw-bold mb-3" style="color: var(--warning-text);">
                            <i class="fas fa-exclamation-triangle me-2"></i>Data Loss Warning
                        </h6>

                        <div class="d-flex align-items-center bg-white p-3 rounded-3 border mb-3 shadow-sm" style="border-color: var(--warning-bg) !important;">
                            <div class="me-3 text-center pe-3 border-end border-light" style="min-width: 70px;">
                                <h2 class="mb-0 fw-bold display-5" id="impact-applicant-count" style="color: var(--primary-color);">0</h2>
                                <small class="fw-bold text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px; color: var(--primary-hover);">Applicants</small>
                            </div>
                            <div>
                                <p class="mb-1 small text-dark fw-bold">All candidate data will be deleted</p>
                                <p class="mb-0 text-muted" style="font-size: 0.8rem;">CVs, cover letters, and <span class="fw-semibold" style="color: var(--warning-text);">interview notes</span> cannot be recovered.</p>
                            </div>
                        </div>

                        <div class="alert mb-4 py-2" style="background-color: var(--primary-soft); border: 1px solid rgba(255, 107, 53, 0.2);">
                            <p class="small fw-bold mb-2" style="color: var(--primary-hover);"><i class="fas fa-info-circle me-1"></i>You will also lose:</p>
                            <ul class="list-unstyled small text-dark mb-0 ps-2">
                                <li class="mb-1"><i class="fas fa-chart-line text-danger me-2" style="width: 14px;"></i>Performance analytics & view history</li>
                                <li class="mb-1"><i class="fas fa-link text-danger me-2" style="width: 14px;"></i>Public job links (will show 404)</li>
                                <li><i class="fas fa-ban text-danger me-2" style="width: 14px;"></i>Cannot be restored by support</li>
                            </ul>
                        </div>

                        <div class="mt-auto">
                            <div class="form-check bg-light p-3 rounded-3 mb-3">
                                <input class="form-check-input mt-1" type="checkbox" id="confirm-delete-checkbox" style="cursor: pointer; border-width: 2px;">
                                <label class="form-check-label small fw-semibold text-dark user-select-none" for="confirm-delete-checkbox" style="cursor: pointer; line-height: 1.4;">
                                    I understand this action is permanent and all data will be lost.
                                </label>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-light flex-grow-1 fw-semibold border" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn flex-grow-1 fw-semibold shadow-sm text-white" id="confirm-delete-btn" onclick="deleteJob()" disabled style="background-color: var(--primary-color); border-color: var(--primary-color);">
                                    <i class="fas fa-trash-alt me-1"></i>Delete Permanently
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT Confirmation Modal (ORANGE THEME - SYSTEM STYLE) -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
            <div class="modal-body text-center p-4">
                <!-- Icon -->
                <div class="d-inline-flex align-items-center justify-content-center rounded-circle mb-3"
                     style="width: 64px; height: 64px; background: rgba(255, 107, 53, 0.1);">
                    <i class="fas fa-pen-to-square" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                </div>

                <!-- Title -->
                <h5 class="fw-bold text-dark mb-2">Confirm Update</h5>

                <!-- Message -->
                <p id="confirmationModalBody" class="text-muted mb-3" style="line-height: 1.6; font-size: 0.9rem;">
                    Are you sure you want to save these changes? You can only edit once.
                </p>

                <!-- Warning Badge -->
                <div class="d-inline-flex align-items-center gap-2 px-3 py-2 mb-4"
                     style="background: var(--warning-bg); border-radius: 50px; border: 1px solid var(--warning-text);">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning-text); font-size: 0.85rem;"></i>
                    <small class="mb-0 fw-semibold" style="color: var(--warning-text);">Cannot be undone</small>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-light flex-grow-1 fw-semibold py-2 border" data-bs-dismiss="modal" style="border-radius: 12px;">
                        Cancel
                    </button>
                    <button type="button" class="btn flex-grow-1 fw-semibold py-2 text-white shadow-sm" id="confirmEditBtn" onclick="submitEditForm()"
                            style="border-radius: 12px; background: var(--primary-color); border: none;">
                        <i class="fas fa-check me-1"></i>Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ========== CLIENT-SIDE PAGINATION LOGIC ==========
    document.addEventListener('DOMContentLoaded', function() {
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) {
            paginationContainer.addEventListener('click', function(event) {
                const target = event.target.closest('a.page-link');
                if (!target) return;

                event.preventDefault();
                const url = new URL(target.href);
                const page = url.searchParams.get('page');

                if (page !== null) {
                    // Add history state for browser back/forward buttons
                    window.history.pushState({ page: page }, '', url.toString());
                    fetchAndRenderPage(page);
                }
            });
        }

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                fetchAndRenderPage(event.state.page, false); // false to not push state again
            } else {
                // Handle initial state if needed, e.g., go back to page 0
                const initialUrl = new URL(window.location);
                const initialPage = initialUrl.searchParams.get('page') || 0;
                fetchAndRenderPage(initialPage, false);
            }
        });
    });

    async function fetchAndRenderPage(page, pushState = true) {
        const grid = document.getElementById('job-card-grid');
        const paginationContainer = document.getElementById('pagination-container');
        const modalsContainer = document.getElementById('modals-container');

        if (!grid) return;

        // Show loading spinner, similar to applicant-viewing.html
        grid.innerHTML = `
            <div class="spinner-container" style="grid-column: 1 / -1;">
                <div class="spinner-border" role="status" style="color: var(--primary-color); width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>`;

        // Create a promise that resolves after a minimum delay of 2 seconds
        const minDelayPromise = new Promise(resolve => setTimeout(resolve, 1000));

        // Create the fetch promise
        const fetchPromise = fetch(`/company/api/jobposting-managing?page=${page}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            });

        try {
            // Wait for both the minimum delay and the data to be fetched
            const [, data] = await Promise.all([minDelayPromise, fetchPromise]);

            // Render new content after fetching
            grid.innerHTML = renderJobCards(data.jobPostings);
            if (modalsContainer) modalsContainer.innerHTML = renderModals(data.jobPostings);
            if (paginationContainer) paginationContainer.innerHTML = renderPagination(data.pagination);

            reinitializeTooltips();
        } catch (error) {
            console.error("Failed to fetch page data:", error);
            // In case of an error, still wait for the minimum delay to avoid flashing
            await minDelayPromise;
            grid.innerHTML = `<div class="text-center py-5 text-danger" style="grid-column: 1 / -1;">
                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                <h6 class="fw-bold">Could not load data</h6>
                                <p class="small text-muted">Please check your connection and try again.</p>
                              </div>`;
            if(typeof showToast === 'function') {
                showToast("Could not load page data. Please try again.", "error");
            }
        }
    }

    function renderJobCards(jobs) {
        if (!jobs || jobs.length === 0) {
            return `
                <div class="empty-state text-center py-5" style="grid-column: 1 / -1;">
                    <div class="mb-4">
                        <div style="width: 100px; height: 100px; background: #fff7ed; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: var(--primary-color);">
                            <i class="fas fa-briefcase fa-3x"></i>
                        </div>
                    </div>
                    <h3 class="mb-2 fw-bold text-dark">No job postings found</h3>
                    <p class="text-muted mb-4">There are no jobs for this page.</p>
                </div>`;
        }

        return jobs.map(job => `
            <div id="job-card-wrapper-${job.id}">
                <div class="job-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="status-badge-modern ${job.status === 'OPEN' ? 'status-open' : (job.status === 'CLOSED' ? 'status-closed' : 'status-draft')}">
                                <span class="card-status-dot" style="background: currentColor;"></span>
                                <span>${job.status || ''}</span>
                            </span>
                            ${isExpiring(job.applicationDeadline) ? `<span class="badge-expiring"><i class="fas fa-clock me-1"></i>Expiring</span>` : ''}
                        </div>
                        <a href="/jobseeker/job-detail/${job.id}" class="card-title-link">${job.title || ''}</a>
                        <div class="company-name">${job.companyName || ''}</div>
                    </div>
                    <div class="card-body pt-0 pb-0 d-flex flex-column">
                        <div class="job-quick-info">
                            ${job.jobType ? `<div class="info-tag"><i class="far fa-clock"></i> <span>${job.jobType}</span></div>` : ''}
                            ${job.location ? `<div class="info-tag"><i class="fas fa-map-marker-alt"></i> <span>${job.location}</span></div>` : ''}
                            ${job.salaryRange ? `<div class="info-tag"><i class="fas fa-dollar-sign"></i> <span>${job.salaryRange}</span></div>` : ''}
                            ${job.experience ? `<div class="info-tag"><i class="fas fa-briefcase"></i> <span>${job.experience}</span></div>` : ''}
                        </div>
                    </div>
                    <div class="applicant-section">
                        <div class="applicant-header">
                            <span><i class="fas fa-user-friends me-1 text-primary"></i> Applicants</span>
                            <span>
                                <span class="fw-bold text-dark">${job.applicantCount || 0}</span>
                                ${job.maxApplicants ? ` / <span>${job.maxApplicants}</span>` : ''}
                            </span>
                        </div>
                        <div class="progress" style="height: 6px; background-color: #e2e8f0; border-radius: 99px;">
                            <div class="progress-bar" style="width: ${(job.maxApplicants && job.maxApplicants > 0) ? (job.applicantCount * 100.0 / job.maxApplicants) : 0}%; background-color: var(--success-text); border-radius: 99px;"></div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <a href="/company/job-view-applicants?jobId=${job.id}" class="btn-view-applicants">Review Applicants</a>
                        <div class="d-flex gap-2">
                            <a href="/jobseeker/job-detail/${job.id}" target="_blank" class="action-icon-btn" data-bs-toggle="tooltip" title="View Public Page"><i class="far fa-eye"></i></a>
                            <button class="action-icon-btn" data-bs-toggle="modal" data-bs-target="#editModal_${job.id}" title="Edit Job"><i class="far fa-edit"></i></button>
                            <button class="action-icon-btn danger" type="button" onclick="prepareDeleteModal(${job.id}, '${escapeSingleQuotes(job.title)}', ${job.applicantCount || 0}, '${job.status}', '${formatDate(job.applicationDeadline)}')"><i class="far fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderPagination(pagination) {
        if (!pagination || pagination.totalPages <= 1) return '';

        const currentPage = pagination.currentPage;
        const totalPages = pagination.totalPages;

        let pagesHtml = '';
        const maxVisible = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages - 1, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(0, endPage - maxVisible + 1);
        }

        if (startPage > 0) {
            pagesHtml += `<li class="page-item"><a class="page-link" href="/company/jobposting-managing?page=0">1</a></li>`;
            if (startPage > 1) {
                pagesHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            pagesHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="/company/jobposting-managing?page=${i}">${i + 1}</a></li>`;
        }

        if (endPage < totalPages - 1) {
            if (endPage < totalPages - 2) {
                pagesHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            pagesHtml += `<li class="page-item"><a class="page-link" href="/company/jobposting-managing?page=${totalPages - 1}">${totalPages}</a></li>`;
        }

        return `
            <nav>
                <ul class="pagination justify-content-center">
                    <li class="page-item ${pagination.currentPage === 0 ? 'disabled' : ''}">
                        <a class="page-link" href="/company/jobposting-managing?page=${pagination.currentPage - 1}">
                            <i class="fas fa-chevron-left small"></i>
                        </a>
                    </li>
                    ${pagesHtml}
                    <li class="page-item ${pagination.currentPage >= pagination.totalPages - 1 ? 'disabled' : ''}">
                        <a class="page-link" href="/company/jobposting-managing?page=${pagination.currentPage + 1}">
                            <i class="fas fa-chevron-right small"></i>
                        </a>
                    </li>
                </ul>
            </nav>`;
    }

    // Helper functions for rendering
    function isExpiring(deadline) {
        if (!deadline) return false;
        const deadlineDate = new Date(deadline);
        const now = new Date();
        const sevenDaysFromNow = new Date();
        sevenDaysFromNow.setDate(now.getDate() + 7);
        return deadlineDate < sevenDaysFromNow && deadlineDate > now;
    }

    function formatDate(dateString) {
        if (!dateString) return 'No Date';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    function escapeSingleQuotes(str) {
        if (!str) return '';
        return str.replace(/'/g, "\\'");
    }

    function reinitializeTooltips() {
        // Dispose of old tooltips
        var oldTooltipList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            .map(function (tooltipTriggerEl) {
                var tooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                if (tooltip) {
                    tooltip.dispose();
                }
                return tooltipTriggerEl;
            });

        // Initialize new tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // This function is needed to re-create modals for the newly loaded jobs
    function renderModals(jobs) {
        // This is a simplified version. For a full implementation, you would need to
        // dynamically generate the complete modal HTML for each job, similar to how it's done with Thymeleaf.
        // Due to complexity, this example will just log a message.
        // A full implementation would require moving the modal's Thymeleaf template into a JS template literal.
        console.log("Modal rendering would happen here for", jobs.length, "jobs.");
        return ''; // In a real scenario, you'd return the full HTML string for all modals.
    }

    // ========== DELETE MODAL LOGIC ==========
    let jobToDeleteId = null;
    const deleteModalElement = document.getElementById('deleteJobModal');
    const deleteModal = new bootstrap.Modal(deleteModalElement);
    const deleteCheckbox = document.getElementById('confirm-delete-checkbox');
    const deleteConfirmBtn = document.getElementById('confirm-delete-btn');

    deleteCheckbox.addEventListener('change', function() {
        deleteConfirmBtn.disabled = !this.checked;
    });

    function prepareDeleteModal(id, title, applicantCount, status, deadlineStr) {
        jobToDeleteId = id;
        deleteCheckbox.checked = false;
        deleteConfirmBtn.disabled = true;

        document.getElementById('delete-job-title-display').textContent = title;
        document.getElementById('impact-applicant-count').textContent = applicantCount;
        document.getElementById('delete-job-status').textContent = status || 'Unknown';
        document.getElementById('delete-job-posted-date').textContent = deadlineStr || '--';

        deleteModal.show();
    }

    function deleteJob() {
        if (!jobToDeleteId) return;

        deleteConfirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        deleteConfirmBtn.disabled = true;

        const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        fetch(`/company/job-posting/${jobToDeleteId}`, {
            method: 'DELETE',
            headers: {
                [csrfHeader]: csrfToken,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    // Animation remove card
                    const card = document.getElementById(`job-card-wrapper-${jobToDeleteId}`);
                    if(card) {
                        card.classList.add('job-card-wrapper-hiding');
                        setTimeout(() => card.remove(), 500);
                    }

                    deleteModal.hide();

                    if(typeof showToast === 'function') {
                        showToast("Job deleted successfully", "success");
                    } else {
                        alert("Job deleted successfully");
                    }

                    // ✅ FIX: Fetch lại dữ liệu KHÔNG reload page
                    const currentUrl = new URL(window.location.href); // ← SỬA ĐÂY
                    const currentPage = currentUrl.searchParams.get('page') || 0;

                    // Wait for animation to complete, then refresh data
                    setTimeout(() => {
                        fetchAndRenderPage(parseInt(currentPage));
                    }, 600);

                } else {
                    throw new Error('Delete failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if(typeof showToast === 'function') {
                    showToast("Failed to delete job", "error");
                } else {
                    alert("Failed to delete job");
                }

                // Reset button
                deleteConfirmBtn.innerHTML = '<i class="fas fa-trash-alt me-1"></i>Delete Permanently';
                deleteConfirmBtn.disabled = false;
            });
    }



    // ========== EDIT MODAL LOGIC ==========
    let currentEditingJobId = null;
    const confirmationModalElement = document.getElementById('confirmationModal');
    const confirmationModal = new bootstrap.Modal(confirmationModalElement);

    function addField(containerId, fieldName) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="text" class="form-control border-end-0" name="${fieldName}" placeholder="New item..." />
            <button type="button" class="btn btn-outline-danger border-start-0 bg-white" onclick="this.closest('.input-group').remove()"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(div);
    }

    function showEditConfirmation(jobId) {
        currentEditingJobId = jobId;
        document.getElementById('confirmationModalBody').textContent = 'Are you sure you want to save these changes? You can only edit once.';

        const editModalEl = document.getElementById(`editModal_${jobId}`);
        const editModal = bootstrap.Modal.getInstance(editModalEl);
        editModal.hide();

        confirmationModal.show();
    }

    function submitEditForm() {
        if (!currentEditingJobId) return;

        const form = document.getElementById(`editForm_${currentEditingJobId}`);
        const formData = new FormData(form);

        const data = {
            id: formData.get('id'),
            title: formData.get('title'),
            jobType: formData.get('jobType'),
            location: formData.get('location'),
            salaryRange: formData.get('salaryRange'),
            experience: formData.get('experience'),
            industry: formData.get('industry'),
            applicationDeadline: formData.get('applicationDeadline'),
            maxApplicants: formData.get('maxApplicants'),
            descriptions: formData.getAll('descriptions').filter(d => d.trim()),
            requirements: formData.getAll('requirements').filter(r => r.trim()),
            benefits: formData.getAll('benefits').filter(b => b.trim())
        };

        const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

        fetch(`/company/job-posting/${currentEditingJobId}`, {
            method: 'PUT',
            headers: {
                [csrfHeader]: csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    confirmationModal.hide();
                    if(typeof showToast === 'function') showToast("Job updated successfully", "success");
                    else alert("Job updated successfully");

                    // [FIX] Instead of reloading the whole page, just fetch the current page data again
                    const currentPage = new URL(window.location.href).searchParams.get('page') || 0;
                    fetchAndRenderPage(currentPage);

                } else {
                    // If response is not OK, parse the JSON error body
                    return response.json().then(errorData => {
                        // Throw an error with the specific message from the server
                        throw new Error(errorData.message || 'Update failed due to an unknown error.');
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Display the specific error message from the server
                if(typeof showToast === 'function') {
                    showToast(error.message, "error");
                } else {
                    alert(error.message);
                }
            });
    }

    // Initialize Tooltips
    reinitializeTooltips();
</script>

<div th:replace="~{fragments/headerAndFooter :: footer}"></div>

</body>
</html>
