<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaoNgoCv - Profile</title>

    <script src="/js/FetchNotification.js" defer></script>
    <script src="/js/Toast.js" defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/whole.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="/js/Notification-filtering.js" defer></script>

    <style>
        /* === CORE SETTINGS === */
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --primary-light: #fff7ed;
            --primary-soft: rgba(249, 115, 22, 0.1);
            --secondary: #dc2626;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 1rem;
            --radius-lg: 1.5rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html, body {
            scroll-behavior: auto !important;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* === CUSTOM DROPDOWN === */
        .custom-select-wrapper { position: relative; width: 100%; }
        .custom-select-trigger {
            background: white; border: 1px solid #e5e7eb; border-radius: var(--radius);
            padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: var(--transition); min-height: 50px;
        }
        .custom-select-trigger:hover { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        .selected-platform { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; }
        .selected-platform i { color: var(--primary); font-size: 1.2rem; width: 24px; text-align: center; }
        .custom-options {
            position: absolute; top: 105%; left: 0; right: 0; background: white;
            border: 1px solid #e5e7eb; border-radius: var(--radius); max-height: 250px;
            overflow-y: auto; z-index: 1000; display: none; box-shadow: var(--shadow-lg);
        }
        .custom-options.show { display: block; animation: fadeIn 0.2s ease; }
        .custom-option {
            padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
            transition: var(--transition); border-bottom: 1px solid #f9fafb;
        }
        .custom-option:hover { background: var(--primary-light); color: var(--primary-dark); }
        .custom-option.selected { background: var(--primary); color: white; }
        .custom-option i { width: 24px; text-align: center; font-size: 1.1rem; }
        .custom-option.selected i { color: white; }

        /* === SLIDE NAVIGATION === */
        .slide-nav {
            position: fixed; right: 2rem; top: 50%; transform: translateY(-50%); z-index: 1000;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            border-radius: 3rem; padding: 1.25rem 0.75rem; box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.6); transition: var(--transition); min-width: 70px;
        }
        .slide-nav.collapsed { transform: translateY(-50%) translateX(calc(100% + 2.5rem)); }
        .nav-toggle {
            position: absolute; left: -25px; top: 50%; transform: translateY(-50%);
            width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none; border-radius: 50%; color: white; box-shadow: var(--shadow-md);
            display: flex; align-items: center; justify-content: center; z-index: 1001; cursor: pointer;
        }
        .nav-items { display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem 0; }
        .slide-nav .nav-item {
            position: relative; width: 55px; height: 55px; border-radius: 50%;
            background: white; border: 1px solid #e5e7eb; color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition); text-decoration: none; font-size: 1.2rem;
        }
        .slide-nav .nav-item:hover, .slide-nav .nav-item.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(249, 115, 22, 0.3); transform: scale(1.1);
        }
        .nav-tooltip {
            position: absolute; right: calc(100% + 15px); top: 50%; transform: translateY(-50%);
            background: #1f2937; color: white; padding: 0.5rem 1rem; border-radius: 8px;
            font-size: 0.85rem; opacity: 0; visibility: hidden; transition: var(--transition); pointer-events: none;
        }
        .nav-item:hover .nav-tooltip { opacity: 1; visibility: visible; right: calc(100% + 10px); }
        .nav-progress { position: absolute; left: 5px; top: 15px; bottom: 15px; width: 3px; background: #e5e7eb; border-radius: 2px; }
        .nav-progress-bar { width: 100%; background: var(--primary); border-radius: 2px; transition: height 0.3s ease; }
        .section-counter {
            position: absolute; bottom: -45px; left: 50%; transform: translateX(-50%);
            background: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem;
            font-weight: 700; color: var(--text-main); box-shadow: var(--shadow-md);
        }

        /* === PROFILE HEADER === */
        .profile-container { padding: 2rem 0 4rem 0; max-width: 1320px; margin: 0 auto; }
        .profile-header {
            background: white; border-radius: var(--radius-lg); overflow: hidden;
            box-shadow: var(--shadow-lg); margin-bottom: 2.5rem; border: none; position: relative;
        }
        .profile-cover {
            height: 280px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            position: relative;
        }
        .profile-cover::after {
            content: ''; position: absolute; inset: 0; opacity: 0.1;
            background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;
        }
        .profile-info { padding: 0 3rem 2.5rem 3rem;  position: relative; z-index: 2; }
        .profile-avatar {
            width: 180px; height: 180px; border: 5px solid white; border-radius: 50%;
            object-fit: cover; box-shadow: var(--shadow-lg); background: white;
            transition: var(--transition); margin-top: -90px;
        }
        .profile-avatar:hover { transform: scale(1.05); box-shadow: var(--shadow-hover); }
        .profile-name {
            font-size: 2.8rem; font-weight: 800; color: var(--text-main); margin-top: 1rem;
            letter-spacing: -0.5px;
        }
        .profile-username { font-size: 1.1rem; color: var(--primary); font-weight: 600; margin-bottom: 1.5rem; }
        .profile-meta { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1.5rem; }
        .meta-item {
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 0.6rem 1.2rem;
            border-radius: 2rem; color: var(--text-muted); font-size: 0.95rem; font-weight: 500;
            display: flex; align-items: center; gap: 0.5rem; transition: var(--transition);
        }
        .meta-item i { color: var(--primary); }
        .meta-item:hover { background: white; border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }

        .profile-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .profile-badge {
            padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.8rem; font-weight: 700;
            text-transform: uppercase; display: flex; align-items: center; gap: 0.5rem;
        }
        .badge-complete { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-age { background: var(--primary-light); color: var(--primary-dark); border: 1px solid rgba(249, 115, 22, 0.2); }
        .badge-member { background: rgba(220, 38, 38, 0.1); color: var(--secondary); border: 1px solid rgba(220, 38, 38, 0.2); }

        .btn-edit-profile {
            background: white; color: var(--text-main); border: 1px solid #e5e7eb;
            padding: 0.8rem 1.8rem; border-radius: 2rem; font-weight: 600;
            box-shadow: var(--shadow-sm); transition: var(--transition); display: inline-flex;
            align-items: center; gap: 0.75rem; text-decoration: none; margin-top: 100px;
        }
        .btn-edit-profile:hover {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3); transform: translateY(-3px);
        }

        /* === CONTENT CARDS === */
        .main-content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; padding: 0 1rem; }
        .section-full-width { grid-column: 1 / -1; }
        .content-card {
            background: white; border-radius: var(--radius); border: none;
            box-shadow: var(--shadow-md); overflow: hidden; transition: var(--transition);
            height: 100%; display: flex; flex-direction: column;
        }
        .content-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-5px); }

        .card-header-compact {
            background: white; padding: 1.5rem 2rem; border-bottom: 1px solid #f1f5f9;
            position: relative; display: flex; justify-content: space-between; align-items: center;
        }
        .card-header-compact::before {
            content: ''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 4px;
            background: var(--primary); border-radius: 0 4px 4px 0;
        }
        .section-title-compact {
            font-size: 1.4rem; font-weight: 700; color: var(--text-main); margin: 0;
            display: flex; align-items: center; gap: 1rem;
        }
        .section-icon-compact {
            width: 40px; height: 40px; background: var(--primary-light); color: var(--primary);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
        }
        .card-body-compact { padding: 2rem; flex-grow: 1; }

        /* Info List */
        .info-item {
            padding: 1rem 0; border-bottom: 1px dashed #e2e8f0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .info-item:last-child { border-bottom: none; }
        .info-label { font-weight: 600; color: var(--text-muted); display: flex; gap: 0.8rem; align-items: center; }
        .info-label i { color: var(--primary); width: 20px; text-align: center; }
        .info-value { font-weight: 500; color: var(--text-main); }

        /* Social Links */
        .social-links-grid-enhanced { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .social-link-item-enhanced {
            display: flex; align-items: center; padding: 1rem; background: #f8fafc;
            border: 1px solid #e2e8f0; border-radius: 12px; text-decoration: none;
            transition: var(--transition);
        }
        .social-link-item-enhanced:hover {
            background: white; border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); transform: translateX(5px);
        }
        .social-icon-compact {
            width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center;
            justify-content: center; font-size: 1.2rem; color: white; margin-right: 1rem;
            background: linear-gradient(135deg, var(--text-muted), var(--text-main));
        }
        /* Platform Colors */
        .social-link-item-enhanced.linkedin .social-icon-compact { background: linear-gradient(135deg, #0077b5, #005885); }
        .social-link-item-enhanced.github .social-icon-compact { background: linear-gradient(135deg, #333, #1a1a1a); }
        .social-link-item-enhanced.facebook .social-icon-compact { background: linear-gradient(135deg, #1877f2, #166fe5); }

        /* Timeline */
        .timeline-compact { position: relative; padding-left: 1rem; margin: 0; list-style: none; }
        .timeline-compact::before {
            content: ''; position: absolute; left: 1rem; top: 0; bottom: 0; width: 2px;
            background: #e2e8f0; border-radius: 2px;
        }
        .timeline-item-compact { position: relative; padding: 0 0 2rem 2.5rem; }
        .timeline-item-compact:last-child { padding-bottom: 0; }
        .timeline-marker-compact {
            position: absolute; left: 0.35rem; top: 0.25rem; width: 1.3rem; height: 1.3rem;
            background: white; border: 4px solid var(--primary); border-radius: 50%; z-index: 2;
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15); transition: var(--transition);
        }
        .timeline-item-compact:hover .timeline-marker-compact {
            background: var(--primary); box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.25); transform: scale(1.1);
        }
        .timeline-content-compact {
            background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border: 1px solid transparent;
            transition: var(--transition);
        }
        .timeline-item-compact:hover .timeline-content-compact {
            background: white; border-color: var(--primary-soft); box-shadow: var(--shadow-md);
        }
        .timeline-title-compact { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--text-main); }
        .timeline-subtitle-compact { color: var(--primary); font-weight: 600; font-size: 0.95rem; margin-bottom: 0.5rem; }
        .timeline-date-compact { font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 0.5rem; align-items: center; }
        .timeline-badges-compact { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .timeline-badge-compact {
            font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 1rem; font-weight: 600;
        }
        .badge-current { background: #dcfce7; color: #15803d; }

        /* Skills */
        .skills-grid-compact { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 1.25rem; }
        .skill-item-compact {
            background: white; border: 1px solid #e2e8f0; border-radius: 1rem; padding: 1.25rem;
            text-align: center; transition: var(--transition); position: relative; overflow: hidden;
        }
        .skill-item-compact:hover {
            border-color: var(--primary); background: var(--primary-light);
            transform: translateY(-5px); box-shadow: var(--shadow-md);
        }
        .skill-icon-compact { font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; }
        .skill-name-compact { font-weight: 600; font-size: 0.9rem; color: var(--text-main); }

        /* Empty State */
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }

        /* Private Warning */
        .private-warning-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        }
        .private-warning-card {
            background: white; padding: 4rem 3rem; border-radius: var(--radius-lg); text-align: center;
            box-shadow: var(--shadow-lg); max-width: 600px; width: 100%;
        }
        .warning-icon {
            width: 100px; height: 100px; background: #fee2e2; color: var(--secondary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; margin: 0 auto 2rem;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.8s ease-out forwards; opacity: 0; }
        .slide-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; transform: translateY(30px); }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 992px) {
            .profile-info { margin-top: 0; text-align: center; }
            .profile-avatar { margin: -90px auto 1rem auto; }
            .profile-meta { justify-content: center; }
            .main-content-grid { grid-template-columns: 1fr; }
            .btn-edit-profile { margin-top: 1rem; }
        }
        @media (max-width: 768px) {
            .profile-header { border-radius: 0; margin-left: -12px; margin-right: -12px; }
            .profile-cover { height: 200px; }
            .card-body-compact { padding: 1.5rem; }
            .slide-nav { display: none; } /* Hide nav on mobile */
        }
    </style>
</head>

<body>
<div th:replace="fragments/headerAndFooter :: header"></div>

<div id="customToastContainer"></div>
<div class="slide-nav collapsed" id="slideNav">
    <button class="nav-toggle" id="navToggle">
        <i class="fas fa-chevron-left"></i>
    </button>
    <div class="nav-progress">
        <div class="nav-progress-bar" id="progressBar" style="height: 0%"></div>
    </div>
    <div class="nav-items">
        <a href="#home" class="nav-item active" data-section="home"><i class="fas fa-home"></i><div class="nav-tooltip">Home</div></a>
        <a href="#about" class="nav-item" data-section="about"><i class="fas fa-user"></i><div class="nav-tooltip">About Me</div></a>
        <a href="#social" class="nav-item" data-section="social"><i class="fas fa-share-alt"></i><div class="nav-tooltip">Social Links</div></a>
        <a href="#experience" class="nav-item" data-section="experience"><i class="fas fa-briefcase"></i><div class="nav-tooltip">Experience</div></a>
        <a href="#education" class="nav-item" data-section="education"><i class="fas fa-graduation-cap"></i><div class="nav-tooltip">Education</div></a>
        <a href="#skills" class="nav-item" data-section="skills"><i class="fas fa-code"></i><div class="nav-tooltip">Skills</div></a>
    </div>
    <div class="section-counter">
        <span id="currentSection">1</span> / <span id="totalSections">6</span>
    </div>
</div>

<div th:if="${profile.isProfilePrivate()}" class="private-warning-container">
    <div class="private-warning-card fade-in">
        <div class="warning-icon">
            <i class="fas fa-lock"></i>
        </div>
        <div class="warning-content">
            <h2 class="fw-bold mb-3 text-dark">Profile is Private</h2>
            <p class="text-muted mb-4">This profile is set to private and cannot be viewed by others.</p>
            <div th:if="${profile.isViewingOwnProfile()}" class="d-flex flex-column gap-3 justify-content-center align-items-center">
                <a href="/jobseeker/profile-settings" class="btn btn-primary px-4 py-2 rounded-pill"><i class="fas fa-cog me-2"></i>Profile Settings</a>
                <a href="/jobseeker/profile-update" class="text-decoration-none text-muted"><i class="fas fa-edit me-1"></i>Edit Profile</a>
            </div>
            <div th:unless="${profile.isViewingOwnProfile()}">
                <a href="/jobseeker/search" class="btn btn-outline-primary rounded-pill px-4"><i class="fas fa-search me-2"></i>Find Other Profiles</a>
            </div>
        </div>
    </div>
</div>

<div th:unless="${profile.isProfilePrivate()}" class="profile-container">

    <section id="home" class="profile-header fade-in">
        <div class="profile-cover"></div>
        <div class="profile-info">
            <div class="row align-items-end">
                <div class="col-lg-8">
                    <div class="d-flex flex-column flex-lg-row align-items-center align-items-lg-start">
                        <img th:src="${profile.profile().profilePicture()} ?: '/img/default-avatar.png'"
                             alt="Profile Avatar" class="profile-avatar" onerror="this.src='/img/default-avatar.png'">
                        <div class="ms-lg-4 mt-3 mt-lg-0 text-center text-lg-start">
                            <h1 class="profile-name" th:text="${profile.profile().fullName()}">John Doe</h1>
                            <p class="profile-username" th:text="'@' + ${profile.profile().username()}">@johndoe</p>
                            <div class="profile-meta">
                                <div class="meta-item" th:if="${profile.profile().email()}"><i class="fas fa-envelope"></i><span th:text="${profile.profile().email()}">email@example.com</span></div>
                                <div class="meta-item" th:if="${profile.profile().phoneNumber()}"><i class="fas fa-phone"></i><span th:text="${profile.profile().phoneNumber()}">+84123456789</span></div>
                                <div class="meta-item" th:if="${profile.profile().address()}"><i class="fas fa-map-marker-alt"></i><span th:text="${profile.profile().address()}">Ho Chi Minh City</span></div>
                            </div>
                            <div class="profile-badges mt-3 justify-content-center justify-content-lg-start">
                                <div class="profile-badge badge-complete" th:if="${profile.profile().hasCompleteProfile()}"><i class="fas fa-check-circle"></i> Complete</div>
                                <div class="profile-badge badge-age" th:if="${profile.profile().getAge()}"><i class="fas fa-birthday-cake"></i> <span th:text="${profile.profile().getAge()} + ' years'">25 years</span></div>
                                <div class="profile-badge badge-member" th:if="${profile.profile().getMemberSince()}"><i class="fas fa-clock"></i> Joined <span th:text="${profile.profile().getMemberSince()}">2023</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end" th:if="${profile.isViewingOwnProfile()}">
                    <a href="/jobseeker/profile-update" class="btn-edit-profile"><i class="fas fa-pen"></i><span>Edit Profile</span></a>
                </div>
            </div>
        </div>
    </section>

    <div class="main-content-grid">

        <section id="about" class="content-card section-half-width slide-up" style="animation-delay: 0.1s;">
            <div class="card-header-compact">
                <h2 class="section-title-compact"><div class="section-icon-compact"><i class="fas fa-user"></i></div>Personal Info</h2>
            </div>
            <div class="card-body-compact">
                <div class="info-item"><span class="info-label"><i class="fas fa-id-card"></i> Full Name</span><span class="info-value" th:text="${profile.profile().fullName()}">John Doe</span></div>
                <div class="info-item"><span class="info-label"><i class="fas fa-calendar"></i> Birthday</span><span class="info-value" th:text="${profile.profile().dateOfBirth() != null ? #temporals.format(profile.profile().dateOfBirth(), 'dd MMM yyyy') : '---'}">01 Jan 1990</span></div>
                <div class="info-item"><span class="info-label"><i class="fas fa-venus-mars"></i> Gender</span><span class="info-value" th:text="${profile.profile().gender() != null ? #strings.capitalizeWords(#strings.toLowerCase(profile.profile().gender())) : '---'}">Male</span></div>
                <div class="info-item"><span class="info-label"><i class="fas fa-flag"></i> Nationality</span><span class="info-value" th:text="${profile.profile().nationality()}">Vietnam</span></div>
                <div class="info-item"><span class="info-label"><i class="fas fa-map-pin"></i> Address</span><span class="info-value text-end" style="max-width: 60%;" th:text="${profile.profile().address()}">HCMC</span></div>
            </div>
        </section>

        <section id="social" class="content-card section-half-width slide-up" style="animation-delay: 0.2s;">
            <div class="card-header-compact">
                <h2 class="section-title-compact"><div class="section-icon-compact"><i class="fas fa-share-alt"></i></div>Social Links</h2>
                <button th:if="${profile.isViewingOwnProfile()}" type="button" class="btn btn-sm btn-outline-secondary rounded-pill" data-bs-toggle="modal" data-bs-target="#socialLinksModal"><i class="fas fa-plus me-1"></i> Add</button>
            </div>
            <div class="card-body-compact">
                <div th:if="${#lists.isEmpty(profile.socialLinks())}" class="empty-state"><i class="fas fa-link"></i><p>No social links added yet.</p></div>
                <div class="social-links-grid-enhanced" th:unless="${#lists.isEmpty(profile.socialLinks())}">
                    <a th:each="link : ${profile.socialLinks()}" th:href="${link.url}" target="_blank" class="social-link-item-enhanced" th:classappend="${#strings.toLowerCase(link.platform.name())}">
                        <div class="social-icon-compact"><i th:class="${link.platform.iconClass}"></i></div>
                        <div class="flex-grow-1"><h6 class="mb-0 fw-bold" th:text="${link.platform.displayName}">LinkedIn</h6><small class="text-muted text-truncate d-block" style="max-width: 250px;" th:text="${link.url}">url...</small></div>
                        <i class="fas fa-external-link-alt text-muted opacity-50"></i>
                    </a>
                </div>
            </div>
        </section>

        <section id="experience" class="content-card section-half-width slide-up" style="animation-delay: 0.3s;">
            <div class="card-header-compact">
                <h2 class="section-title-compact"><div class="section-icon-compact"><i class="fas fa-briefcase"></i></div>Experience</h2>
            </div>
            <div class="card-body-compact">
                <div th:if="${#lists.isEmpty(profile.jobExperiences())}" class="empty-state"><i class="fas fa-briefcase"></i><p class="mb-3">No experience added.</p><a th:if="${profile.isViewingOwnProfile()}" href="/jobseeker/profile-update" class="btn btn-sm btn-primary rounded-pill">Add Now</a></div>
                <ul class="timeline-compact" th:unless="${#lists.isEmpty(profile.jobExperiences())}">
                    <li class="timeline-item-compact" th:each="job : ${profile.jobExperiences()}">
                        <div class="timeline-marker-compact"></div>
                        <div class="timeline-content-compact">
                            <h4 class="timeline-title-compact" th:text="${job.jobTitle()}">Job Title</h4>
                            <p class="timeline-subtitle-compact" th:text="${job.companyName()}">Company</p>
                            <p class="timeline-date-compact"><i class="far fa-calendar-alt"></i><span th:text="${job.startDate() != null ? #temporals.format(job.startDate(), 'MMM yyyy') : 'N/A'}">Start</span> - <span th:text="${job.endDate() != null ? #temporals.format(job.endDate(), 'MMM yyyy') : 'Present'}">End</span></p>
                            <div class="timeline-badges-compact" th:if="${job.isCurrentJob()}"><span class="timeline-badge-compact badge-current">Current Job</span></div>
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <section id="education" class="content-card section-half-width slide-up" style="animation-delay: 0.4s;">
            <div class="card-header-compact">
                <h2 class="section-title-compact"><div class="section-icon-compact"><i class="fas fa-graduation-cap"></i></div>Education</h2>
            </div>
            <div class="card-body-compact">
                <div th:if="${#lists.isEmpty(profile.educations())}" class="empty-state"><i class="fas fa-graduation-cap"></i><p class="mb-3">No education added.</p><a th:if="${profile.isViewingOwnProfile()}" href="/jobseeker/profile-update" class="btn btn-sm btn-primary rounded-pill">Add Now</a></div>
                <ul class="timeline-compact" th:unless="${#lists.isEmpty(profile.educations())}">
                    <li class="timeline-item-compact" th:each="edu : ${profile.educations()}">
                        <div class="timeline-marker-compact"></div>
                        <div class="timeline-content-compact">
                            <h4 class="timeline-title-compact" th:text="${edu.getFullDegree()}">Degree</h4>
                            <p class="timeline-subtitle-compact" th:text="${edu.institution()}">University</p>
                            <p class="timeline-date-compact"><i class="far fa-calendar-alt"></i><span th:text="${edu.startDate() != null ? #temporals.format(edu.startDate(), 'yyyy') : 'N/A'}">2018</span> - <span th:text="${edu.endDate() != null ? #temporals.format(edu.endDate(), 'yyyy') : 'Present'}">2022</span></p>
                        </div>
                    </li>
                </ul>
            </div>
        </section>

        <section id="skills" class="content-card section-full-width slide-up" style="animation-delay: 0.5s;">
            <div class="card-header-compact">
                <h2 class="section-title-compact"><div class="section-icon-compact"><i class="fas fa-code"></i></div>Skills</h2>
                <button th:if="${profile.isViewingOwnProfile()}" type="button" class="btn btn-sm btn-outline-secondary rounded-pill" data-bs-toggle="modal" data-bs-target="#skillsModal"><i class="fas fa-edit me-1"></i> Edit</button>
            </div>
            <div class="card-body-compact">
                <div th:if="${#lists.isEmpty(profile.skills())}" class="empty-state"><i class="fas fa-tools"></i><p>Showcase your skills here.</p><button th:if="${profile.isViewingOwnProfile()}" class="btn btn-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#skillsModal">Select Skills</button></div>
                <div class="skills-grid-compact" th:unless="${#lists.isEmpty(profile.skills())}">
                    <div class="skill-item-compact" th:each="skill : ${profile.skills()}">
                        <div class="skill-icon-compact"><i th:class="${skill.iconClass}"></i></div>
                        <div class="skill-name-compact" th:text="${skill.displayName}">Java</div>
                    </div>
                </div>
            </div>
        </section>

    </div>
</div>

<div class="modal fade" id="skillsModal" tabindex="-1" th:if="${profile.isViewingOwnProfile}">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-code me-2 text-primary"></i>Edit Skills</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <input type="text" id="skill-search-input" class="form-control form-control-lg mb-3 shadow-sm border-0" placeholder="Search skills...">
                <div id="skills-checkbox-grid" class="d-grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));">
                    <div class="skill-checkbox-item position-relative bg-white p-1 rounded-3" th:each="skillEnum : ${T(com.example.baoNgoCv.model.enums.Skill).values()}" th:data-skill-name="${#strings.toLowerCase(skillEnum.displayName)}">
                        <input type="checkbox" th:id="'skill-' + ${skillEnum.name()}" th:value="${skillEnum.name()}" th:checked="${profile.skills != null ? profile.skills.contains(skillEnum) : false}" class="btn-check">
                        <label th:for="'skill-' + ${skillEnum.name()}" class="btn btn-outline-light text-dark w-100 text-start d-flex align-items-center gap-2 border shadow-sm">
                            <i th:class="${skillEnum.iconClass} + ' text-primary'"></i><span th:text="${skillEnum.displayName}">Java</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-white">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="saveSkillsButton">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="socialLinksModal" tabindex="-1" th:if="${profile.isViewingOwnProfile}">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-share-alt me-2 text-primary"></i>Manage Links</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
                <div id="social-links-pills-container" class="bg-white p-3 rounded-3 shadow-sm mb-4 d-flex flex-wrap gap-2 min-vh-10"></div>
                <div class="bg-white p-3 rounded-3 shadow-sm">
                    <h6 class="fw-bold mb-3">Add New Link</h6>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <div class="custom-select-wrapper">
                                <div class="custom-select-trigger" id="customPlatformSelect">
                                    <span class="selected-platform"><i class="fas fa-plus"></i><span>Platform...</span></span><i class="fas fa-chevron-down text-muted"></i>
                                </div>
                                <div class="custom-options" id="customPlatformOptions">
                                    <div class="custom-option" th:each="platform : ${T(com.example.baoNgoCv.model.enums.SocialPlatform).values()}" th:data-value="${platform.name()}" th:data-display="${platform.displayName}" th:data-icon="${platform.iconClass}">
                                        <i th:class="${platform.iconClass}"></i><span th:text="${platform.displayName}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6"><input type="url" id="new-social-url" class="form-control form-control-lg" placeholder="https://..."></div>
                        <div class="col-md-1"><button class="btn btn-success w-100 h-100 rounded-3" type="button" id="addSocialLinkButtonEnhanced"><i class="fas fa-plus"></i></button></div>
                    </div>
                    <div id="social-link-error" class="text-danger mt-2 small" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer bg-white">
                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-4" id="saveSocialLinksButton">Save All</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/headerAndFooter :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/FetchNotification.js" defer></script>

<script th:inline="javascript">
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    /*<![CDATA[*/
    try {
        history.scrollRestoration = 'manual';
        const scrollPosition = sessionStorage.getItem('scrollPosition');
        if (scrollPosition && parseInt(scrollPosition, 10) > 0) {
            window.scrollTo(0, parseInt(scrollPosition, 10));
            sessionStorage.removeItem('scrollPosition');
        }
    } catch (e) { console.error(e); }

    document.addEventListener("DOMContentLoaded", function () {
        const message = /*[[${toastMessage}]]*/ null;
        const type = /*[[${toastType}]]*/ null;
        if (message && type) showToast(message, type);

        initSkillsModal();
        initSocialLinksModal();

        // Slide Nav Logic
        class SlideNavigation {
            constructor() {
                this.slideNav = document.getElementById('slideNav');
                this.navToggle = document.getElementById('navToggle');
                this.navItems = this.slideNav.querySelectorAll('.nav-item');
                this.progressBar = document.getElementById('progressBar');
                this.currentSectionSpan = document.getElementById('currentSection');
                this.totalSectionsSpan = document.getElementById('totalSections');
                this.sections = document.querySelectorAll('section[id]');
                this.isCollapsed = true;
                this.currentSectionIndex = 0;
                this.init();
            }
            init() {
                this.setupEventListeners();
                this.updateTotalSections();
                this.handleScroll();
                this.observeSections();
            }
            setupEventListeners() {
                this.navToggle.addEventListener('click', () => this.toggleNavigation());
                this.navItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = item.getAttribute('href').substring(1);
                        const target = document.getElementById(targetId);
                        if(target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                });
                window.addEventListener('scroll', () => this.handleScroll());
            }
            toggleNavigation() {
                this.isCollapsed = !this.isCollapsed;
                this.slideNav.classList.toggle('collapsed', this.isCollapsed);
                this.navToggle.querySelector('i').className = this.isCollapsed ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
            }
            handleScroll() {
                const scrollTop = window.pageYOffset;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                this.progressBar.style.height = (scrollTop / docHeight) * 100 + '%';
                this.updateActiveSection();
            }
            updateActiveSection() {
                const scrollPos = window.scrollY + 150;
                this.sections.forEach((sec, idx) => {
                    if (scrollPos >= sec.offsetTop && scrollPos < sec.offsetTop + sec.offsetHeight) {
                        this.setActiveSection(idx);
                    }
                });
            }
            setActiveSection(index) {
                if (index !== this.currentSectionIndex) {
                    this.currentSectionIndex = index;
                    this.navItems.forEach(item => item.classList.remove('active'));
                    if (this.navItems[index]) this.navItems[index].classList.add('active');
                    this.currentSectionSpan.textContent = index + 1;
                }
            }
            updateTotalSections() { this.totalSectionsSpan.textContent = this.sections.length; }
            observeSections() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) this.setActiveSection(Array.from(this.sections).indexOf(entry.target));
                    });
                }, { threshold: 0.2 });
                this.sections.forEach(s => observer.observe(s));
            }
        }
        if (document.getElementById('slideNav')) new SlideNavigation();

        // Animation Observer
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.slide-up, .fade-in').forEach(el => observer.observe(el));
    });

    // Dropdown Logic
    function initCustomPlatformSelect() {
        const trigger = document.getElementById('customPlatformSelect');
        const options = document.getElementById('customPlatformOptions');
        if (!trigger || !options) return null;
        const customOptions = options.querySelectorAll('.custom-option');
        let selectedValue = '', selectedDisplayName = '', selectedIcon = '';

        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            options.classList.toggle('show');
        });

        customOptions.forEach(option => {
            option.addEventListener('click', function() {
                selectedValue = this.dataset.value;
                selectedDisplayName = this.dataset.display;
                selectedIcon = this.dataset.icon;
                customOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                trigger.querySelector('.selected-platform').innerHTML = `<i class="${selectedIcon}"></i><span>${selectedDisplayName}</span>`;
                options.classList.remove('show');
            });
        });
        document.addEventListener('click', () => options.classList.remove('show'));

        return {
            getValue: () => selectedValue,
            getDisplayName: () => selectedDisplayName,
            getIcon: () => selectedIcon,
            reset: () => {
                selectedValue = ''; selectedDisplayName = ''; selectedIcon = '';
                customOptions.forEach(opt => opt.classList.remove('selected'));
                trigger.querySelector('.selected-platform').innerHTML = `<i class="fas fa-plus"></i><span>Platform...</span>`;
            }
        };
    }

    // Skills Modal Logic
    function initSkillsModal() {
        const modalEl = document.getElementById('skillsModal');
        const saveBtn = document.getElementById('saveSkillsButton');
        const searchInp = document.getElementById('skill-search-input');
        const grid = document.getElementById('skills-checkbox-grid');
        if (!modalEl || !saveBtn) return;

        let userSkills = new Set(/*[[${profile.skills.![name()]}]]*/ []);

        modalEl.addEventListener('show.bs.modal', () => {
            grid.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = userSkills.has(cb.value));
            searchInp.value = '';
            searchInp.dispatchEvent(new Event('keyup'));
        });

        searchInp.addEventListener('keyup', () => {
            const term = searchInp.value.toLowerCase();
            grid.querySelectorAll('.skill-checkbox-item').forEach(item => {
                item.style.display = item.dataset.skillName.includes(term) ? 'block' : 'none';
            });
        });

        saveBtn.addEventListener('click', function() {
            const selected = Array.from(grid.querySelectorAll('input:checked')).map(cb => cb.value);
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            const headers = { 'Content-Type': 'application/json' };
            if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

            fetch('/jobseeker/update-skills', { method: 'POST', headers: headers, body: JSON.stringify(selected) })
                .then(res => res.ok ? res.json() : res.json().then(e => { throw new Error(e.message); }))
                .then(data => {
                    bootstrap.Modal.getInstance(modalEl).hide();
                    showToast(data.message || 'Updated!', 'success');
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(err => showToast(err.message, 'danger'))
                .finally(() => { this.disabled = false; this.textContent = 'Save Changes'; });
        });
    }

    // Social Links Logic
    // Social Links Logic (Đã sửa lỗi undefined)
    function initSocialLinksModal() {
        const modalEl = document.getElementById('socialLinksModal');
        if (!modalEl) return;

        const container = document.getElementById('social-links-pills-container');
        const addBtn = document.getElementById('addSocialLinkButtonEnhanced');
        const saveBtn = document.getElementById('saveSocialLinksButton');
        const urlInp = document.getElementById('new-social-url');
        const errDiv = document.getElementById('social-link-error');

        // 1. Lấy dữ liệu thô từ Server
        let rawLinks = /*[[${profile.socialLinks()}]]*/ [];
        let socialLinks = [];
        let platformSelect;

        // Helper: Hàm render lại giao diện
        const render = () => {
            container.innerHTML = '';
            if(socialLinks.length === 0) container.innerHTML = '<small class="text-muted fst-italic w-100 text-center d-block py-4">No links waiting to save.</small>';

            socialLinks.forEach((link, idx) => {
                const div = document.createElement('div');
                // Kiểm tra kỹ data trước khi render để tránh undefined
                const icon = link.platform ? (link.platform.iconClass || 'fas fa-link') : 'fas fa-link';
                const name = link.platform ? (link.platform.displayName || 'Link') : 'Link';

                div.className = 'badge bg-white text-dark p-3 ps-3 rounded-pill d-flex align-items-center gap-3 border shadow-sm fw-bold';
                div.innerHTML = `<i class="${icon} text-primary fs-5"></i> <span class="text-truncate" style="max-width:200px">${name}</span> <button type="button" class="btn-close btn-close-dark ms-auto" aria-label="Remove"></button>`;
                div.querySelector('button').onclick = () => { socialLinks.splice(idx, 1); render(); };
                container.appendChild(div);
            });
        };

        modalEl.addEventListener('show.bs.modal', () => {
            platformSelect = initCustomPlatformSelect();

            // 2. [QUAN TRỌNG] Tạo Map để tra cứu thông tin Platform từ HTML có sẵn
            // Vì server chỉ gửi tên Enum (String), ta cần lấy Icon/DisplayName từ DOM
            const platformMap = {};
            const optionElements = document.querySelectorAll('#customPlatformOptions .custom-option');
            optionElements.forEach(el => {
                platformMap[el.dataset.value] = {
                    name: el.dataset.value,
                    displayName: el.dataset.display,
                    iconClass: el.dataset.icon
                };
            });

            // 3. Chuẩn hóa dữ liệu: Biến String thành Object đầy đủ
            socialLinks = rawLinks.map(link => {
                // Kiểm tra xem platform là String (tên Enum) hay đã là Object
                let pName = typeof link.platform === 'string' ? link.platform : (link.platform.name || link.platform);

                // Nếu tìm thấy thông tin đầy đủ trong Map thì dùng, không thì giữ nguyên
                if (platformMap[pName]) {
                    return {
                        url: link.url,
                        platform: platformMap[pName] // Object đầy đủ {name, displayName, iconClass}
                    };
                }
                return link;
            });

            render();
        });

        addBtn.addEventListener('click', () => {
            const pf = platformSelect.getValue();
            const name = platformSelect.getDisplayName();
            const icon = platformSelect.getIcon();
            const url = urlInp.value.trim();

            errDiv.style.display = 'none';
            if (!pf || !url) { errDiv.style.display = 'block'; return; }

            // Khi thêm mới, ta đã có đủ object
            socialLinks.push({
                platform: { name: pf, displayName: name, iconClass: icon },
                url: url
            });

            render();
            platformSelect.reset();
            urlInp.value = '';
        });

        saveBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

            // Khi gửi lên server, chỉ cần gửi tên Enum (String) là đủ
            const payload = socialLinks.map(l => ({
                platform: l.platform.name || l.platform,
                url: l.url
            }));

            const headers = { 'Content-Type': 'application/json' };
            if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

            fetch('/jobseeker/update-social-links', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
                .then(async res => {
                    if (res.ok) return res.json();
                    const errorBody = await res.json();
                    throw new Error(errorBody.detail || 'An unknown error occurred.');
                })
                .then(data => {
                    bootstrap.Modal.getInstance(modalEl).hide();
                    showToast(data.message || 'Updated!', 'success');
                    sessionStorage.setItem('scrollPosition', window.scrollY);
                    setTimeout(() => window.location.reload(), 1000);
                })
                .catch(err => showToast(err.message, 'danger'))
                .finally(() => { this.disabled = false; this.textContent = 'Save All'; });
        });
    }
    /*]]>*/
</script>
</body>
</html>