<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>BaoNgoCv - Edit Company Profile</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="/js/Notification-filtering.js" defer></script>
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/whole.css" rel="stylesheet">

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/Toast.js" defer></script>

    <style>
        :root {
            --primary: #ff6b35;
            --primary-hover: #e65a26;
            --primary-light: #fff0eb;
            --primary-gradient: linear-gradient(135deg, #ff6b35 0%, #ff8f5a 100%);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --card-radius: 20px;
            --input-radius: 12px;
            --shadow-soft: 0 10px 30px -10px rgba(0,0,0,0.06);
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
            /* ✨ [FIX] Re-apply flexbox for sticky footer layout */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Container & Card --- */
        .edit-container {
            max-width: 1000px;
            margin: 2rem auto 4rem;
            padding: 0 1rem;
            /* ✨ [FIX] Force this container to grow and push the footer down */
            flex-grow: 1;
        }

        .profile-card {
            background: var(--bg-surface);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
            border: 1px solid #f1f5f9;
        }

        /* --- Cover Photo --- */
        .cover-photo {
            height: 180px;
            background: var(--primary-gradient);
            position: relative;
            background-image: radial-gradient(rgba(255, 255, 255, 0.15) 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* --- Header Section --- */
        .header-section {
            padding: 0 2.5rem;
            margin-top: -60px; /* Overlap effect */
            margin-bottom: 2rem;
            display: flex;
            align-items: flex-end;
            gap: 2rem;
            flex-wrap: wrap;
        }

        /* Avatar Edit Box */
        .avatar-wrapper {
            position: relative;
            flex-shrink: 0;
            group: hover;
        }

        .company-avatar-box {
            width: 140px;
            height: 140px;
            background: #fff;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .company-avatar {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 16px;
            background: #fff;
            border: 1px solid #f1f5f9;
        }

        /* Edit Overlay for Avatar */
        .avatar-edit-overlay {
            position: absolute;
            inset: 5px; /* Match padding of box */
            border-radius: 16px;
            background: rgba(30, 41, 59, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }

        .avatar-wrapper:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .avatar-edit-btn {
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        /* Header Texts */
        .header-info {
            flex-grow: 1;
            padding-bottom: 10px;
        }

        .page-heading {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.25rem;
        }

        .page-subheading {
            color: var(--text-sub);
            font-size: 0.95rem;
        }

        /* --- Tabs --- */
        .nav-tabs-custom {
            display: flex;
            gap: 1rem;
            padding: 0 2.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 0.5rem;
            font-weight: 600;
            color: var(--text-sub);
            position: relative;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        /* --- Content Body --- */
        .content-body {
            padding: 0 2.5rem 3rem;
            min-height: 60vh; /* Set a minimum height */
        }

        /* Form Styles */
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: var(--input-radius);
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            color: var(--text-main);
            transition: all 0.2s;
            background-color: #fcfcfc;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            background-color: #fff;
        }

        .form-control:disabled, .form-control[readonly] {
            background-color: #f1f5f9;
            color: #94a3b8;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        /* Buttons */
        .btn-save {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.25);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 53, 0.35);
            color: white;
        }

        .btn-save:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Validation */
        .field-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-top: -70px;
            }
            .header-info { width: 100%; padding-bottom: 0; }
            .content-body { padding: 0 1.5rem 2rem; }
            .nav-tabs-custom { padding: 0 1.5rem; justify-content: center; }
            .btn-save { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/headerAndFooter :: header}"></div>
<div id="customToastContainer"></div>

<main class="edit-container">
    <div class="profile-card">
        <!-- Cover Photo -->
        <div class="cover-photo"></div>

        <!-- Header Info -->
        <div class="header-section">
            <div class="avatar-wrapper">
                <div class="company-avatar-box">
                    <img th:src="${(currentCompany.companyLogoUrl != null and !#strings.isEmpty(currentCompany.companyLogoUrl)) ? currentCompany.companyLogoUrl : '/img/default/default-company-logo.png'}"
                         alt="Company Logo" id="companyLogoPreview" class="company-avatar"
                         onerror="this.onerror=null; this.src='/img/default/default-company-logo.png';">

                    <!-- Nút sửa ảnh đè lên -->
                    <label for="companyLogoInput" class="avatar-edit-overlay">
                        <div class="avatar-edit-btn">
                            <i class="fas fa-camera"></i>
                            <span>Edit</span>
                        </div>
                    </label>
                </div>
                <!-- Input file ẩn, nằm ngoài form chính để xử lý riêng hoặc chung form -->
                <!-- Chú ý: Input này cần nằm trong form hoặc được JS xử lý để gửi đi -->
            </div>

            <div class="header-info">
                <h1 class="page-heading">Edit Company Profile</h1>
                <p class="page-subheading">Update your company details and contact information.</p>
            </div>
        </div>

        <!-- Navigation Tabs (Dạng Simple) -->
        <div class="nav-tabs-custom">
            <button type="button" class="tab-btn active" onclick="switchTab('details', this)">
                Company Details
            </button>
            <button type="button" class="tab-btn" onclick="switchTab('contact', this)">
                Contact & Identity
            </button>
        </div>

        <!-- Content Body -->
        <div class="content-body">

            <!-- FORM 1: Company Details -->
            <form id="form-details" method="post" enctype="multipart/form-data">
                <!-- Input File Logo thực tế (ẩn) -->
                <input type="file" id="companyLogoInput" name="logoFile" class="d-none" accept="image/*" onchange="previewLogo(this)">

                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="industry" class="form-label">Industry <span class="text-danger">*</span></label>
                        <select id="industry" name="industryId" class="form-select" required>
                            <option value="" disabled>Select Industry</option>
                            <option th:each="industry : ${T(com.example.baoNgoCv.model.enums.IndustryType).values()}"
                                    th:value="${industry}"
                                    th:text="${industry.displayName}"
                                    th:selected="${currentCompany.industry != null && currentCompany.industry.equals(industry.name())}">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="companySize" class="form-label">Company Size</label>
                        <input type="text" id="companySize" name="companySize" class="form-control"
                               th:value="${currentCompany.companySize}" placeholder="e.g. 50-100">
                    </div>

                    <div class="col-12">
                        <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea id="description" name="description" class="form-control"
                                  placeholder="Tell us about your company..." required th:text="${currentCompany.description}"></textarea>
                    </div>

                    <div class="col-12 pt-2">
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-check"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>

            <!-- FORM 2: Contact Info (Hidden by default) -->
            <form id="form-contact" method="post" style="display: none;">
                <div class="row g-4">
                    <div class="col-12">
                        <label for="companyName" class="form-label">Official Company Name <span class="text-danger">*</span></label>
                        <input type="text" id="companyName" name="companyName" class="form-control fw-bold"
                               th:value="${currentCompany.name}" required>
                    </div>

                    <div class="col-md-6">
                        <label for="location" class="form-label">Location <span class="text-danger">*</span></label>
                        <input type="text" id="location" name="location" class="form-control"
                               th:value="${currentCompany.location}" required>
                    </div>

                    <div class="col-md-6">
                        <label for="website" class="form-label">Website URL</label>
                        <input type="url" id="website" name="website" class="form-control"
                               th:value="${currentCompany.website}" placeholder="https://example.com">
                    </div>

                    <div class="col-md-6">
                        <label for="contactEmail" class="form-label">Contact Email</label>
                        <input type="email" id="contactEmail" name="contactEmail" class="form-control bg-light"
                               th:value="${currentCompany.contactEmail}" readonly disabled>
                        <div class="form-text text-muted small">Email cannot be changed.</div>
                    </div>

                    <div class="col-md-6">
                        <label for="contactPhone" class="form-label">Phone Number</label>
                        <input type="tel" id="contactPhone" name="contactPhone" class="form-control"
                               th:value="${currentCompany.contactPhone}" placeholder="+84...">
                    </div>

                    <div class="col-12 pt-2">
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-check"></i> Save Contact Info
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</main>

<div th:replace="~{fragments/headerAndFooter :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // --- API Config ---
    const API_CONFIG = { baseURL: window.location.origin };
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

    const request = async (method, url, data) => {
        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers[csrfHeader] = csrfToken;

        const config = { method, url, headers };

        if (data instanceof FormData) {
            delete headers['Content-Type'];
            config.data = data;
        } else {
            config.data = data;
        }

        try {
            const res = await axios(config);
            return res.data;
        } catch (err) {
            throw err.response?.data || { message: err.message };
        }
    };

    // --- Tab Switching ---
    function switchTab(tabName, btn) {
        // Hide all forms
        document.getElementById('form-details').style.display = 'none';
        document.getElementById('form-contact').style.display = 'none';

        // Show selected form
        document.getElementById(`form-${tabName}`).style.display = 'block';

        // Update Active State
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // --- Logo Preview ---
    function previewLogo(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if(file.size > 5 * 1024 * 1024) {
                showToast('File too large (>5MB)', 'error');
                input.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => document.getElementById('companyLogoPreview').src = e.target.result;
            reader.readAsDataURL(file);
        }
    }

    // --- Form Submission Handlers ---

    // 1. Details Form
    document.getElementById('form-details').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        setLoading(btn, true);

        const formData = new FormData();
        formData.append('industry', document.getElementById('industry').value);
        formData.append('companySize', document.getElementById('companySize').value);
        formData.append('description', document.getElementById('description').value);

        const fileInput = document.getElementById('companyLogoInput');
        if (fileInput.files[0]) formData.append('logoFile', fileInput.files[0]);

        try {
            const res = await request('PUT', '/company/information', formData);
            showToast(res.message || 'Updated successfully!', 'success');
            if(res.data?.newLogoUrl) document.getElementById('companyLogoPreview').src = res.data.newLogoUrl;
        } catch (err) {
            showToast(err.message || 'Update failed', 'error');
        } finally {
            setLoading(btn, false);
        }
    });

    // 2. Contact Form
    document.getElementById('form-contact').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        setLoading(btn, true);

        const payload = {
            companyName: document.getElementById('companyName').value,
            location: document.getElementById('location').value,
            website: document.getElementById('website').value,
            contactPhone: document.getElementById('contactPhone').value
        };

        try {
            await request('PUT', '/company/contact', payload);
            showToast('Contact info updated!', 'success');
        } catch (err) {
            showToast(err.message || 'Update failed', 'error');
        } finally {
            setLoading(btn, false);
        }
    });

    function setLoading(btn, isLoading) {
        if(isLoading) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Save Changes';
        }
    }
</script>

</body>
</html>
